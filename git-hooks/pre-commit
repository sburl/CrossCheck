#!/bin/bash
# Pre-commit hook: Quality gates before commit
# Addresses: Timestamp lag, secrets detection, code quality

set -e

echo "üîç Running pre-commit checks..."

# 1. Doc timestamp verification (addresses recurring lag issue)
# Canonical format: **Last Updated:** YYYY-MM-DD-HH-MM (matches doc-timestamp skill)
echo "  üìù Checking doc timestamps..."
today=$(date +%Y-%m-%d)
while IFS= read -r -d '' file; do
    [ -f "$file" ] || continue
    if ! grep -q "^\*\*Last Updated:\*\* $today" "$file"; then
        echo "  ‚ö†Ô∏è  $file: timestamp not updated to today ($today)"
        echo "     Run: /doc-timestamp or manually update"
        echo "     Skipping check (warning only)"
        # Don't block, just warn
    fi
done < <(git diff --cached --name-only --diff-filter=ACM -z | grep -z '\.md$')

# 2. Protect user-content/ directory (human-only zone)
if git diff --cached --name-only | grep -q '^user-content/'; then
    echo "  ‚ùå Files in user-content/ directory are being committed"
    echo "     user-content/ is a human-only zone - agents must never modify it"
    echo "     If YOU (the human) made these changes intentionally:"
    echo "       git commit --no-verify  (humans only -- agents are blocked from this)"
    exit 1
fi

# 3. Secrets detection
echo "  üîí Checking for secrets..."

# Check for common API key patterns (only in added lines, not deletions)
if git diff --cached | grep -E '^\+[^+]' | grep -qiE '(api_key|apikey|password|secret|token|aws_access|private_key|bearer|auth|credential)(\s*[=:]\s*)["\x27]?(sk-|pk-|[a-zA-Z0-9_-]{20,})["\x27]?'; then
    echo "  ‚ùå Possible secret detected in staged changes"
    echo "     Common patterns: API keys, tokens, passwords (20+ chars)"
    echo "     Review carefully. If false positive: --no-verify is blocked by permissions"
    exit 1
fi

# Check specifically for OpenAI/Anthropic API keys (these are never false positives)
if git diff --cached | grep -E '^\+[^+]' | grep -qE '(OPENAI_API_KEY|ANTHROPIC_API_KEY|CLAUDE_API_KEY).*=.*["\x27]?sk-(proj-|ant-)?[a-zA-Z0-9]{20,}'; then
    echo "  ‚ùå OpenAI/Anthropic API key detected - MUST NOT COMMIT"
    echo "     Use environment variables: export OPENAI_API_KEY=\$YOUR_KEY"
    exit 1
fi

# Check for .env files (only added/modified, not deletions)
if git diff --cached --name-only --diff-filter=ACM | grep -qE '\.env$|\.env\.'; then
    echo "  ‚ùå .env file in staged changes"
    echo "     .env files should never be committed"
    exit 1
fi

# 4. Check for debug statements
echo "  üêõ Checking for debug code..."
if git diff --cached | grep -E '^\+[^+]' | grep -qE '\b(console\.log|debugger|import pdb|breakpoint\(\)|print\()'; then
    echo "  ‚ö†Ô∏è  Debug statements found (console.log, debugger, pdb, breakpoint, print)"
    echo "     Consider removing before commit"
    # Don't block, just warn
fi

# 5. Verify tests exist for new code files
echo "  üß™ Checking test coverage..."
while IFS= read -r file; do
    [ -z "$file" ] && continue
    # Check for corresponding test file
    basename_no_ext=$(basename "${file%.*}")

    # Look for test file in common patterns
    if ! git ls-files | grep -qE "(test.*$basename_no_ext|$basename_no_ext.*test|$basename_no_ext.*spec|__tests__.*$basename_no_ext)"; then
        echo "  ‚ö†Ô∏è  No test file found for new file: $file"
        echo "     Consider adding tests (warning only)"
    fi
done < <(git diff --cached --name-only --diff-filter=A | grep -E '\.(py|ts|tsx|js|jsx)$' | grep -v -E '(test|spec|__tests__)')

# 6. Security-sensitive change detection
security_files=$(git diff --cached --name-only | grep -iE '(auth|security|permission|credential|token|secret|crypto|encrypt|ssl|tls|cert|\.env|config/.*secret|middleware/auth)' || true)
if [ -n "$security_files" ]; then
    echo ""
    echo "  üîí Security-sensitive files detected in this commit:"
    echo "$security_files" | sed 's/^/     /'
    echo "     Review docs/rules/trust-model.md for trust boundaries and zero-trust rules."
    echo ""
fi

echo "‚úÖ Pre-commit checks passed"
